pipeline {
    agent any
    
    environment {
        HARBOR_HOST = '10.2.2.40:5000'
        IMAGE_NAME = 'integrated-dashboard'
        GITEA_HOST = '10.2.2.40:3001'
        // ⚠️ 실제 소스코드 주소 확인 필요
        SOURCE_REPO = "http://jenkins:JenkinsPass123@${GITEA_HOST}/admin/myapp-source.git"
    }
    
    stages {
        stage('Build & Push Image') {
            steps {
                sh """
                    ssh -i /var/jenkins_home/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.2.2.40 '
                        set -e
                        rm -rf /tmp/myweb_build && mkdir -p /tmp/myweb_build
                        git clone ${SOURCE_REPO} /tmp/myweb_build
                        cd /tmp/myweb_build
                        
                        docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} .
                        docker login ${HARBOR_HOST} -u admin -p Admin123
                        # Latest 태그도 같이 생성
                        docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${HARBOR_HOST}/library/${IMAGE_NAME}:${BUILD_NUMBER}
                        docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${HARBOR_HOST}/library/${IMAGE_NAME}:latest
                        docker push ${HARBOR_HOST}/library/${IMAGE_NAME}:${BUILD_NUMBER}
                        docker push ${HARBOR_HOST}/library/${IMAGE_NAME}:latest
                        
                        rm -rf /tmp/myweb_build
                        docker rmi ${IMAGE_NAME}:${BUILD_NUMBER} || true
                        docker rmi ${HARBOR_HOST}/library/${IMAGE_NAME}:${BUILD_NUMBER} || true
                    '
                """
            }
        }
        
        stage('Update Helm Chart') {
            steps {
                sh """
                    ssh -i /var/jenkins_home/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.2.2.40 '
                        set -e
                        rm -rf /tmp/gitops_myweb && mkdir -p /tmp/gitops_myweb
                        cd /tmp/gitops_myweb
                        git clone http://jenkins:JenkinsPass123@${GITEA_HOST}/admin/myapp-helm.git .
                        
                        git config user.email "jenkins@antigravity.local"
                        git config user.name "Jenkins CI"
                        
                        # ✅ 경로: my-web (최상위)
                        sed -i "s/tag: .*/tag: \\"${BUILD_NUMBER}\\"/" my-web/helm/values.yaml
                        
                        git add my-web/helm/values.yaml
                        if ! git diff-index --quiet HEAD; then
                            git commit -m "Bump my-web tag to ${BUILD_NUMBER}"
                            git push http://jenkins:JenkinsPass123@${GITEA_HOST}/admin/myapp-helm.git main
                        fi
                        rm -rf /tmp/gitops_myweb
                    '
                """
            }
        }
    }
}