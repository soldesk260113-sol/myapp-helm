pipeline {
    agent any
    
    // âœ… íŒŒë¼ë¯¸í„° ì¶”ê°€: ë°°í¬í•  íƒœê·¸ë¥¼ ì§ì ‘ ì…ë ¥ë°›ìŒ (ê¸°ë³¸ê°’: latest)
    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'ë°°í¬í•  Harbor ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: latest, 1, v1.0)')
    }
    
    environment {
        GITEA_HOST = '10.2.2.40:3001'
    }
    
    stages {
        // [1ë‹¨ê³„: ë¹Œë“œ] ì‚­ì œë¨ 
        
        // [2ë‹¨ê³„] Helm Chart ë²„ì „ ì—…ë°ì´íŠ¸ (ì´ê²ƒë§Œ ì‹¤í–‰)
        stage('Update Helm Chart') {
            steps {
                echo "â˜¸ï¸ energy-api ë°°í¬ ì‹œì‘: Harbor íƒœê·¸(${params.IMAGE_TAG}) ì ìš©"
                
                sh """
                    ssh -i /var/jenkins_home/.ssh/id_rsa -o StrictHostKeyChecking=no root@10.2.2.40 '
                        set -e
                        
                        # 1. ì‘ì—… ê³µê°„ ì¤€ë¹„
                        rm -rf /tmp/gitops_energy && mkdir -p /tmp/gitops_energy
                        cd /tmp/gitops_energy
                        
                        # 2. Helm ì €ì¥ì†Œ ê°€ì ¸ì˜¤ê¸°
                        git clone http://jenkins:JenkinsPass123@${GITEA_HOST}/admin/myapp-helm.git .
                        
                        git config user.email "jenkins@antigravity.local"
                        git config user.name "Jenkins CI"
                        
                        # 3. values.yaml ìˆ˜ì • (ì…ë ¥ë°›ì€ íƒœê·¸ë¡œ ë³€ê²½)
                        # âœ… ê²½ë¡œ í™•ì¸: Applications/energy-api í´ë”
                        sed -i "s/tag: .*/tag: \\"${params.IMAGE_TAG}\\"/" energy-api/helm/values.yaml
                        
                        # 4. ë³€ê²½ì‚¬í•­ í™•ì¸
                        echo "ğŸ” ë³€ê²½ëœ íƒœê·¸ í™•ì¸:"
                        grep "tag:" energy-api/helm/values.yaml
                        
                        git add energy-api/helm/values.yaml
                        
                        # ë³€ê²½ëœ ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ Gitì— ì˜¬ë¦¼
                        if ! git diff-index --quiet HEAD; then
                            git commit -m "Deploy energy-api image tag: ${params.IMAGE_TAG}"
                            git push http://jenkins:JenkinsPass123@${GITEA_HOST}/admin/myapp-helm.git main
                            echo "âœ… Helm Chart ì—…ë°ì´íŠ¸ ì™„ë£Œ! ArgoCDê°€ ê³§ ë°°í¬í•©ë‹ˆë‹¤."
                        else
                            echo "âš ï¸ ë³€ê²½ ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ í•´ë‹¹ íƒœê·¸ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤)"
                        fi
                        
                        # 5. ì •ë¦¬
                        rm -rf /tmp/gitops_energy
                    '
                """
            }
        }
    }
}